<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­ªå…”å…”ä»£è³¼ OMS v16.2</title>
    
    <!-- é˜²å¿«å–é‡‘ç‰Œ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- åŠ å…¥ä¸»ç•«é¢è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081559.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* iOS Performance Fixes */
        html, body {
            height: 100%;
            overflow: hidden; 
            background-color: #0f172a;
        }
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        #root {
            height: 100%;
            display: flex;
            justify-content: center;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .checkbox-wrapper input[type="checkbox"] {
            accent-color: #10b981;
            width: 1.2rem;
            height: 1.2rem;
            cursor: pointer;
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .toast-enter {
            animation: slideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, memo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Users, PlusCircle, Wallet, ArrowUpRight, ArrowDownLeft, 
            Package, Truck, CheckCircle2, UserPlus, Trash2, X, 
            Cloud, Share, HelpCircle, FileSpreadsheet, List, Lock, Download,
            ClipboardList, History, Archive, Box, ShoppingBag, CheckSquare, Plus, AlertTriangle,
            RotateCcw, Edit, Check, Tag, FolderPlus, Layers, Search, Banknote, Camera, Pencil, RefreshCw
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, 
            orderBy, serverTimestamp, deleteDoc, doc, updateDoc, writeBatch 
        } from 'firebase/firestore';

        // --- Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyAJTIQ0FmzsOSlBRiAzBt7K9upReEQMSn0",
          authDomain: "runy-buy.firebaseapp.com",
          projectId: "runy-buy",
          storageBucket: "runy-buy.firebasestorage.app",
          messagingSenderId: "846500832046",
          appId: "1:846500832046:web:70bd619a66875f9bea90bf",
          measurementId: "G-KYVY0DX7N1"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const SHARED_GROUP_ID = 'main_accounting_group'; 
        const APP_VERSION = "v16.2";

        const UsagiIcon = () => (
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-yellow-300">
                <path d="M12 2C12 2 8 2 7 6C6 10 7 12 7 12C7 12 4 13 4 16C4 19 6 22 12 22C18 22 20 19 20 16C20 13 17 12 17 12C17 12 18 10 17 6C16 2 12 2 12 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M9 15C9 15 10 16 12 16C14 16 15 15 15 15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M9 12H9.01" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M15 12H15.01" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
        );

        // --- Shared Components ---

        const Toast = ({ message, type, isVisible, onClose }) => {
            useEffect(() => {
                if (isVisible) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [isVisible, onClose]);

            if (!isVisible) return null;

            return (
                <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-[10000] flex items-center gap-2 toast-enter ${type === 'error' ? 'bg-rose-600 text-white' : 'bg-emerald-500 text-white'}`}>
                    {type === 'success' ? <CheckCircle2 size={20} /> : <AlertTriangle size={20} />}
                    <span className="font-bold text-sm tracking-wide">{message}</span>
                </div>
            );
        };

        const StatCard = memo(({ title, value, type, icon: Icon }) => (
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                <div className="flex justify-between items-start mb-2">
                    <div className={`p-2 rounded-lg ${
                        type === 'income' ? 'bg-emerald-500/20 text-emerald-400' :
                        type === 'expense' ? 'bg-rose-500/20 text-rose-400' :
                        'bg-blue-500/20 text-blue-400'
                    }`}>
                        <Icon size={20} />
                    </div>
                    <span className="text-slate-400 text-xs font-medium uppercase tracking-wider">{title}</span>
                </div>
                <div className="text-2xl font-bold text-white">
                    {type === 'balance' ? 'NT$ ' : type === 'income' ? '+ ' : '- '}
                    {value.toLocaleString()}
                </div>
            </div>
        ));

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "ç¢ºèª", cancelText = "å–æ¶ˆ", isDestructive = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center animate-in fade-in duration-200 p-4" style={{zIndex: 9999}}>
                    <div className="bg-slate-900 w-full max-w-sm rounded-2xl p-6 border border-slate-700 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <div className="text-slate-300 text-sm mb-6 whitespace-pre-wrap">{message}</div>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 bg-slate-800 rounded-xl text-slate-300 font-medium hover:bg-slate-700">{cancelText}</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl text-white font-bold shadow-lg ${isDestructive ? 'bg-rose-600 hover:bg-rose-500' : 'bg-emerald-600 hover:bg-emerald-500'}`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const BatchPurchaseModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            const [cost, setCost] = useState('');
            if (!isOpen) return null;

            const handleConfirm = () => {
                if(!cost) return;
                onConfirm(cost);
                setCost('');
            }

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center animate-in fade-in duration-200 p-4" style={{zIndex: 9999}}>
                    <div className="bg-slate-900 w-full max-w-sm rounded-2xl p-6 border border-slate-700 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <div className="text-slate-300 text-sm mb-4 whitespace-pre-wrap">{message}</div>
                        <div className="mb-6">
                            <label className="block text-emerald-400 text-xs font-bold mb-1">è«‹è¼¸å…¥æœ¬æ¬¡æ¡è³¼ç¸½æˆæœ¬ (å¿…å¡«)</label>
                            <input type="number" value={cost} onChange={(e) => setCost(e.target.value)} className="w-full bg-slate-800 border border-slate-600 text-white p-3 rounded-xl text-lg focus:border-emerald-500 outline-none" placeholder="$ 0" autoFocus />
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => { setCost(''); onCancel(); }} className="flex-1 py-3 bg-slate-800 rounded-xl text-slate-300 font-medium hover:bg-slate-700">å–æ¶ˆ</button>
                            <button onClick={handleConfirm} disabled={!cost} className={`flex-1 py-3 rounded-xl text-white font-bold shadow-lg ${cost ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>ç¢ºèªæ¡è³¼</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditOrderModal = ({ isOpen, onClose, order, onSave }) => {
            const [quantity, setQuantity] = useState(0);
            const [amount, setAmount] = useState(0);
            const [note, setNote] = useState('');

            useEffect(() => {
                if (order) {
                    setQuantity(order.quantity || 1);
                    setAmount(order.amount || 0);
                    setNote(order.note || '');
                }
            }, [order, isOpen]);

            if (!isOpen || !order) return null;

            const handleSubmit = () => {
                onSave(order.id, {
                    quantity: Number(quantity),
                    amount: Number(amount),
                    note
                });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center animate-in fade-in duration-200 p-4" style={{zIndex: 10000}}>
                     <div className="bg-slate-900 w-full max-w-sm rounded-2xl p-6 border border-slate-700 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Edit size={20}/> ä¿®æ”¹è¨‚å–®</h3>
                        
                        <div className="mb-4 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                            <div className="text-xs text-slate-400 mb-1">{order.customerName}</div>
                            <div className="text-white font-medium">{order.description}</div>
                        </div>

                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-slate-400 text-sm mb-1">æ•¸é‡</label>
                                    <input type="number" value={quantity} onChange={(e) => setQuantity(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" />
                                </div>
                                <div>
                                    <label className="block text-slate-400 text-sm mb-1">ç¸½é‡‘é¡</label>
                                    <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-slate-400 text-sm mb-1">å‚™è¨»</label>
                                <input type="text" value={note} onChange={(e) => setNote(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" />
                            </div>
                            <div className="flex gap-3 mt-4">
                                <button onClick={onClose} className="flex-1 py-3 bg-slate-800 rounded-xl text-slate-400">å–æ¶ˆ</button>
                                <button onClick={handleSubmit} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">å„²å­˜ä¿®æ”¹</button>
                            </div>
                        </div>
                     </div>
                </div>
            );
        };

        const SearchBar = ({ value, onChange, placeholder = "æœå°‹..." }) => (
            <div className="relative mb-4">
                <Search className="absolute left-3 top-2.5 text-slate-500" size={18} />
                <input 
                    type="text" 
                    value={value} 
                    onChange={(e) => onChange(e.target.value)} 
                    placeholder={placeholder}
                    className="w-full bg-slate-800 border border-slate-700 text-white pl-10 p-2 rounded-xl focus:outline-none focus:border-indigo-500"
                />
            </div>
        );

        const SwipeableListItem = memo(({ children, onDelete, confirmMessage = "ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ" }) => {
            const [offsetX, setOffsetX] = useState(0);
            const [showConfirm, setShowConfirm] = useState(false);
            const startX = useRef(0);
            const isDragging = useRef(false);

            const onTouchStart = (e) => {
                startX.current = e.touches[0].clientX;
                isDragging.current = true;
            };

            const onTouchMove = (e) => {
                if (!isDragging.current) return;
                const currentX = e.touches[0].clientX;
                const diff = currentX - startX.current;
                if (diff < 0 && diff > -120) setOffsetX(diff);
                else if (diff > 0) setOffsetX(0);
            };

            const onTouchEnd = () => {
                isDragging.current = false;
                if (offsetX < -50) setOffsetX(-80);
                else setOffsetX(0);
            };

            return (
                <div className="relative mb-2 overflow-hidden rounded-lg bg-rose-600 border border-slate-700 touch-pan-y">
                    <div 
                        className="absolute right-0 top-0 bottom-0 w-[80px] flex items-center justify-center text-white z-0 cursor-pointer"
                        onClick={() => setShowConfirm(true)}
                    >
                        <Trash2 size={24} />
                    </div>
                    <div 
                        className="relative bg-slate-800 z-10 w-full"
                        style={{ transform: `translateX(${offsetX}px)`, transition: isDragging.current ? 'none' : 'transform 0.2s ease-out' }}
                        onTouchStart={onTouchStart}
                        onTouchMove={onTouchMove}
                        onTouchEnd={onTouchEnd}
                    >
                        {children}
                        {offsetX === -80 && <div className="absolute top-0 right-[-80px] w-[80px] h-full z-20 cursor-pointer" onClick={(e) => { e.stopPropagation(); setShowConfirm(true); }} />}
                    </div>
                    <ConfirmModal 
                        isOpen={showConfirm}
                        title="ç¢ºèªåˆªé™¤"
                        message={confirmMessage}
                        confirmText="åˆªé™¤"
                        isDestructive={true}
                        onConfirm={() => { onDelete(); setShowConfirm(false); setOffsetX(0); }}
                        onCancel={() => { setShowConfirm(false); setOffsetX(0); }}
                    />
                </div>
            );
        });

        const useGroupedTransactions = (transactions, statusFilter, searchTerm, selectedCategory) => {
            return useMemo(() => {
                const filtered = transactions.filter(t => {
                    const statusMatch = Array.isArray(statusFilter) ? statusFilter.includes(t.status) : t.status === statusFilter;
                    const searchMatch = !searchTerm || (t.description?.includes(searchTerm) || t.customerName?.includes(searchTerm));
                    let catMatch = true;
                    if (selectedCategory !== 'All') {
                        if (selectedCategory === 'Uncategorized') catMatch = !t.description.startsWith('[');
                        else catMatch = t.description.startsWith(`[${selectedCategory}]`);
                    }
                    return statusMatch && searchMatch && catMatch;
                });
                const groups = {};
                filtered.forEach(t => {
                    const key = t.description || 'æœªåˆ†é¡å•†å“';
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(t);
                });
                return { groups, sortedKeys: Object.keys(groups).sort(), filteredItems: filtered };
            }, [transactions, statusFilter, searchTerm, selectedCategory]);
        };

        // 1. æ¥å–®å€ (Active Orders)
        const ActiveOrdersView = ({ transactions, categories, updateTransactionStatus, onAppendOrder, onDeleteTransaction, onEditOrder, showToast }) => {
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [searchTerm, setSearchTerm] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [purchaseModalData, setPurchaseModalData] = useState(null);
            
            const { groups, sortedKeys, filteredItems } = useGroupedTransactions(transactions, ['pending', 'paid'], searchTerm, selectedCategory);

            const handleCategoryPurchaseClick = () => {
                if (filteredItems.length === 0) {
                    showToast("âš ï¸ æ­¤ä¸»é¡Œä¸‹ç›®å‰ç„¡è¨‚å–®", "error");
                    return;
                }
                const unpaidCount = filteredItems.filter(t => t.status !== 'paid').length;
                const catName = selectedCategory === 'All' ? "æ‰€æœ‰é¡¯ç¤ºå•†å“" : selectedCategory;
                
                const msg = unpaidCount > 0 
                    ? `âš ï¸ æ³¨æ„ï¼š"${catName}" é‚„æœ‰ ${unpaidCount} ç­†è¨‚å–®å°šæœªä»˜æ¬¾ã€‚\nå°‡å¼·åˆ¶åŸ·è¡Œæ¡è³¼ã€‚`
                    : `å°‡ "${catName}" (å…± ${filteredItems.length} ç­†) æ¨™è¨˜ç‚ºæ¡è³¼ã€‚`;

                setPurchaseModalData({
                    items: filteredItems,
                    title: "ä¸»é¡Œæ‰¹æ¬¡æ¡è³¼ & æˆæœ¬éŒ„å…¥",
                    message: msg
                });
            };

            const executeBatchPurchase = async (costInput) => {
                if (!purchaseModalData) return;
                setIsProcessing(true);
                try {
                    const batch = writeBatch(db);
                    purchaseModalData.items.forEach(t => { const ref = doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions', t.id); batch.update(ref, { status: 'purchased' }); });
                    const costRef = doc(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions'));
                    const desc = selectedCategory === 'All' ? 'æ‰¹æ¬¡æ¡è³¼æˆæœ¬' : `[${selectedCategory}] æ‰¹æ¬¡æ¡è³¼æˆæœ¬`;
                    batch.set(costRef, { type: 'expense', category: 'æ¡è³¼æˆæœ¬', description: desc, amount: Number(costInput), date: serverTimestamp(), status: 'completed' });
                    await batch.commit();
                    showToast("âœ… å…¨æ•¸æ¡è³¼æˆåŠŸï¼");
                } catch (e) { console.error(e); alert("æ›´æ–°å¤±æ•—"); }
                setIsProcessing(false); setPurchaseModalData(null);
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="mb-2 flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-white flex items-center gap-2 mb-2"><ClipboardList size={24} className="text-blue-400"/> æ¥å–®å€</h2>
                        
                        {/* Only show Full Purchase button if a specific category is selected (not All, not Uncategorized) */}
                        {selectedCategory !== 'All' && selectedCategory !== 'Uncategorized' && (
                            <button 
                                onClick={handleCategoryPurchaseClick}
                                className="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-lg border border-purple-500 flex items-center gap-1 active:scale-95 transition-transform"
                            >
                                <ShoppingBag size={14}/> å…¨æ•¸æ¡è³¼ (æ­¤ä¸»é¡Œ)
                            </button>
                        )}
                    </div>
                    <SearchBar value={searchTerm} onChange={setSearchTerm} placeholder="æœå°‹å•†å“æˆ–é¡§å®¢..." />
                    <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-2">
                        <button onClick={() => setSelectedCategory('All')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${selectedCategory === 'All' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>å…¨éƒ¨</button>
                        {categories.map(cat => (<button key={cat.id} onClick={() => setSelectedCategory(cat.name)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${selectedCategory === cat.name ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>{cat.name}</button>))}
                        <button onClick={() => setSelectedCategory('Uncategorized')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${selectedCategory === 'Uncategorized' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>æœªåˆ†é¡</button>
                    </div>
                    <div className="flex-1 overflow-auto bg-slate-900/50 rounded-xl custom-scrollbar space-y-4 p-1">
                        {sortedKeys.map(productName => {
                            const items = groups[productName];
                            const totalAmount = items.reduce((sum, t) => sum + Number(t.amount), 0);
                            const totalQty = items.reduce((sum, t) => sum + (Number(t.quantity) || 1), 0);
                            const guessPrice = items.length > 0 ? Math.round(Number(items[0].amount) / (Number(items[0].quantity) || 1)) : 0;
                            return (
                                <div key={productName} className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden relative shadow-md">
                                    <div className="bg-slate-700/50 p-3 flex justify-between items-center sticky top-0 z-20 backdrop-blur-sm border-b border-slate-700/50">
                                        <div className="flex-1"><h3 className="font-bold text-white text-lg flex items-center gap-2 flex-wrap">{productName}<button onClick={() => onAppendOrder(productName, guessPrice)} className="bg-emerald-600/80 hover:bg-emerald-500 text-white p-1 rounded-full shadow-lg active:scale-95"><Plus size={14} /></button></h3><div className="text-xs text-slate-400">æ•¸é‡: <span className="text-white font-bold">{totalQty}</span> Â· ç¸½é¡: <span className="text-white font-bold">${totalAmount.toLocaleString()}</span></div></div>
                                    </div>
                                    <div className="divide-y divide-slate-700/50">
                                        {items.map(t => (
                                            <SwipeableListItem key={t.id} onDelete={async () => { await onDeleteTransaction(t.id); showToast("ğŸ—‘ï¸ è¨‚å–®å·²åˆªé™¤", "error"); }} confirmMessage={`ç¢ºå®šè¦åˆªé™¤ "${t.customerName}" çš„é€™ç­†è¨‚å–®å—ï¼Ÿ`}>
                                                <div className="p-3 flex justify-between items-center w-full">
                                                    <div className="flex items-center gap-3 flex-1 min-w-0">
                                                        <div className={`w-2 h-2 rounded-full flex-shrink-0 ${t.status === 'paid' ? 'bg-blue-500' : 'bg-yellow-500'}`}></div>
                                                        <div className="min-w-0">
                                                            <div className="text-slate-200 font-medium flex items-center gap-1">
                                                                {t.customerName}
                                                                {(t.quantity > 1) && <span className="text-xs bg-slate-600 px-1 rounded text-white flex-shrink-0">x{t.quantity}</span>}
                                                            </div>
                                                            <div className="text-[10px] text-slate-500 truncate">{t.note || new Date(t.date?.seconds * 1000).toLocaleDateString()}</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2 flex-shrink-0">
                                                        <button onClick={() => onEditOrder(t)} className="p-1.5 text-slate-400 hover:text-white bg-slate-700/50 rounded-lg border border-slate-600">
                                                            <Edit size={14} />
                                                        </button>
                                                        <span className="font-mono font-bold text-slate-300 w-14 text-right">${t.amount}</span>
                                                        <button onClick={async () => { await updateTransactionStatus(t.id, t.status === 'pending' ? 'paid' : 'pending'); showToast("âœ… ç‹€æ…‹å·²æ›´æ–°"); }} className={`text-xs px-2 py-1.5 rounded border transition-all w-14 text-center ${t.status === 'paid' ? 'bg-blue-500 text-white border-blue-500' : 'bg-slate-800 text-slate-400 border-slate-600'}`}>{t.status === 'paid' ? 'å·²åŒ¯æ¬¾' : 'å¾…è™•ç†'}</button>
                                                    </div>
                                                </div>
                                            </SwipeableListItem>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                         {sortedKeys.length === 0 && <div className="text-center py-10 text-slate-500"><div className="mb-2">ğŸ“­</div>ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</div>}
                    </div>
                    <BatchPurchaseModal isOpen={!!purchaseModalData} title={purchaseModalData?.title} message={purchaseModalData?.message} onConfirm={executeBatchPurchase} onCancel={() => setPurchaseModalData(null)} />
                </div>
            );
        };

        const WaitingGoodsView = ({ transactions, categories, updateTransactionStatus, onDeleteTransaction, showToast }) => {
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [searchTerm, setSearchTerm] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [confirmAction, setConfirmAction] = useState(null);
            const { groups, sortedKeys } = useGroupedTransactions(transactions, 'purchased', searchTerm, selectedCategory);

            const handleBatchShip = (productName, items) => { setConfirmAction({ type: 'ship', items, title: "ç¢ºèªå¯„å‡º", message: `ç¢ºå®šå·²å°‡ "${productName}" (å…± ${items.length} ç­†) å…¨éƒ¨å¯„å‡ºäº†å—ï¼Ÿ` }); };
            const executeBatchAction = async () => {
                if(!confirmAction) return; setIsProcessing(true);
                try { 
                    const batch = writeBatch(db); 
                    confirmAction.items.forEach(t => { const ref = doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions', t.id); if(confirmAction.type === 'ship') batch.update(ref, { status: 'shipped' }); }); 
                    await batch.commit(); 
                    showToast("ğŸšš å•†å“å·²å…¨æ•¸å¯„å‡ºï¼");
                } catch(e) { console.error(e); alert("æ“ä½œå¤±æ•—"); }
                setIsProcessing(false); setConfirmAction(null);
            };
            const handleSingleRevert = async (t) => { if(confirm(`ç¢ºå®šè¦å°‡ "${t.customerName}" çš„ "${t.description}" é€€å›æ¥å–®å€å—ï¼Ÿ`)) { await updateTransactionStatus(t.id, 'paid'); showToast("â†©ï¸ å·²å›å¾©è‡³æ¥å–®å€"); } };

            return (
                <div className="h-full flex flex-col">
                    <div className="mb-2"><h2 className="text-2xl font-bold text-white flex items-center gap-2 mb-2"><Box size={24} className="text-purple-400"/> ç­‰å¾…å•†å“å€</h2></div>
                    <SearchBar value={searchTerm} onChange={setSearchTerm} placeholder="æœå°‹å¾…è²¨å•†å“..." />
                    <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-2">
                        <button onClick={() => setSelectedCategory('All')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${selectedCategory === 'All' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>å…¨éƒ¨</button>
                        {categories.map(cat => (<button key={cat.id} onClick={() => setSelectedCategory(cat.name)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${selectedCategory === cat.name ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>{cat.name}</button>))}
                    </div>
                    <div className="flex-1 overflow-auto bg-slate-900/50 rounded-xl custom-scrollbar space-y-4 p-1">
                        {sortedKeys.map(productName => {
                            const items = groups[productName];
                            const totalQty = items.reduce((sum, t) => sum + (Number(t.quantity) || 1), 0);
                            return (
                                <div key={productName} className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden relative shadow-md">
                                    <div className="bg-slate-700/50 p-3 flex justify-between items-center sticky top-0 z-20 backdrop-blur-sm border-b border-slate-700/50">
                                        <div className="flex-1"><h3 className="font-bold text-white text-lg">{productName}</h3><div className="text-xs text-slate-400">å¾…å‡ºè²¨æ•¸é‡: <span className="text-white font-bold">{totalQty}</span></div></div>
                                        <button onClick={() => handleBatchShip(productName, items)} className="flex-shrink-0 px-3 py-2 rounded-lg text-xs font-bold bg-emerald-600 hover:bg-emerald-500 text-white border-emerald-500 transition-all border shadow-lg">å…¨æ•¸å¯„å‡º</button>
                                    </div>
                                    <div className="divide-y divide-slate-700/50">
                                        {items.map(t => (
                                            <SwipeableListItem key={t.id} onDelete={async () => { await onDeleteTransaction(t.id); showToast("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸ"); }} confirmMessage="ç¢ºå®šè¦åˆªé™¤é€™ç­†ç­‰å¾…ä¸­çš„å•†å“å—ï¼Ÿ">
                                                <div className="p-3 flex justify-between items-center w-full">
                                                    <div className="flex items-center gap-3 flex-1 min-w-0"><div className="min-w-0"><div className="font-medium text-white truncate">{t.customerName}</div><div className="text-xs text-purple-400 flex items-center gap-1">å·²æ¡è³¼ {(t.quantity > 1) && <span className="text-white bg-slate-600 px-1 rounded">x{t.quantity}</span>}</div></div></div>
                                                    <div className="flex items-center gap-3 flex-shrink-0"><span className="font-mono font-bold text-slate-300">${t.amount?.toLocaleString()}</span><button onClick={() => handleSingleRevert(t)} className="text-slate-500 hover:text-yellow-500 p-1" title="å›å¾©åˆ°æ¥å–®å€"><RotateCcw size={16} /></button></div>
                                                </div>
                                            </SwipeableListItem>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                        {sortedKeys.length === 0 && <div className="p-10 text-center text-slate-500">æ²’æœ‰ç­‰å¾…ä¸­çš„å•†å“</div>}
                    </div>
                    <ConfirmModal isOpen={!!confirmAction} title={confirmAction?.title} message={confirmAction?.message} confirmText="ç¢ºèª" onConfirm={executeBatchAction} onCancel={() => setConfirmAction(null)} />
                </div>
            );
        };

        const HistoryView = memo(({ transactions, handleDeleteTransaction, updateTransactionStatus, showToast }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const historyTrans = transactions.filter(t => t.status === 'shipped' && (!searchTerm || t.description.includes(searchTerm) || t.customerName.includes(searchTerm)));
            const [revertItem, setRevertItem] = useState(null);
            const [showClearConfirm, setShowClearConfirm] = useState(false);

            const handleClearHistory = async () => {
                const batch = writeBatch(db);
                historyTrans.forEach(t => {
                    const ref = doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions', t.id);
                    batch.delete(ref);
                });
                try {
                    await batch.commit();
                    showToast("ğŸ—‘ï¸ æ­·å²è¨‚å–®å·²å…¨éƒ¨æ¸…ç©º");
                } catch(e) {
                    console.error(e);
                    alert("åˆªé™¤å¤±æ•— (è³‡æ–™é‡å¯èƒ½éå¤§)");
                }
                setShowClearConfirm(false);
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-white flex items-center gap-2"><History size={24} className="text-emerald-400"/> æ­·å²è¨‚å–®</h2>
                        {historyTrans.length > 0 && (
                            <button onClick={() => setShowClearConfirm(true)} className="text-xs bg-rose-900/50 text-rose-300 border border-rose-800 px-3 py-1.5 rounded-lg hover:bg-rose-900 transition-colors">
                                ğŸ’¥ æ¸…ç©ºæ­·å²
                            </button>
                        )}
                    </div>
                    <SearchBar value={searchTerm} onChange={setSearchTerm} placeholder="æœå°‹æ­·å²è¨‚å–®..." />
                    <div className="flex-1 overflow-auto space-y-2 custom-scrollbar pr-1">
                        {historyTrans.map(t => (
                            <SwipeableListItem key={t.id} onDelete={async () => { await handleDeleteTransaction(t.id); showToast("ğŸ—‘ï¸ åˆªé™¤æˆåŠŸ"); }} confirmMessage="ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†æ­·å²è¨‚å–®å—ï¼Ÿ">
                                <div className="p-3 flex justify-between items-center w-full">
                                    <div className="flex items-center gap-3 overflow-hidden"><CheckCircle2 size={16} className="text-emerald-500 flex-shrink-0"/><div className="truncate"><div className="text-sm text-slate-300 flex items-center gap-2 truncate">{t.description} {(t.quantity > 1) && <span className="text-[10px] bg-slate-600 px-1 rounded text-white flex-shrink-0">x{t.quantity}</span>}</div><div className="text-xs text-slate-500">{t.customerName} Â· {new Date(t.date?.seconds * 1000).toLocaleDateString()}</div></div></div>
                                    <div className="flex items-center gap-3"><span className="font-mono text-slate-400">${t.amount}</span><button onClick={() => setRevertItem(t)} className="text-slate-600 hover:text-yellow-500 p-1"><RotateCcw size={14} /></button></div>
                                </div>
                            </SwipeableListItem>
                        ))}
                         {historyTrans.length === 0 && <div className="p-10 text-center text-slate-500">æ²’æœ‰æ­·å²è³‡æ–™</div>}
                    </div>
                    <ConfirmModal isOpen={!!revertItem} title="ç¢ºèªé€€å›ï¼Ÿ" message="é€€å›è‡³ç­‰å¾…å€ï¼Ÿ" confirmText="é€€å›" onConfirm={() => { updateTransactionStatus(revertItem.id, 'purchased'); showToast("â†©ï¸ å·²å›å¾©è‡³ç­‰å¾…å€"); setRevertItem(null); }} onCancel={() => setRevertItem(null)} />
                    <ConfirmModal isOpen={showClearConfirm} title="âš ï¸ å±éšªæ“ä½œï¼šæ¸…ç©ºæ­·å²" message={`ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ ${historyTrans.length} ç­†æ­·å²è¨‚å–®å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`} confirmText="ç¢ºèªæ¸…ç©º" isDestructive={true} onConfirm={handleClearHistory} onCancel={() => setShowClearConfirm(false)} />
                </div>
            );
        });

        const ShippingCostView = ({ transactions, onDeleteTransaction, showToast }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const costs = transactions.filter(t => t.category === 'å…¶ä»–æ”¯å‡º' && (!searchTerm || t.description.includes(searchTerm)));
            const total = costs.reduce((sum, t) => sum + Number(t.amount), 0);

            return (
                <div className="h-full flex flex-col">
                    <div className="mb-4"><h2 className="text-2xl font-bold text-white flex items-center gap-2 mb-1"><Banknote size={24} className="text-orange-400"/> å…¶ä»–æ”¯å‡ºæ˜ç´°</h2><div className="text-sm text-slate-400">ç´¯è¨ˆæ”¯å‡ºï¼š<span className="text-white font-bold text-lg">${total.toLocaleString()}</span></div></div>
                    <SearchBar value={searchTerm} onChange={setSearchTerm} placeholder="æœå°‹æ”¯å‡ºé …ç›®..." />
                    <div className="flex-1 overflow-auto space-y-2 custom-scrollbar pr-1">
                        {costs.map(t => (
                            <SwipeableListItem key={t.id} onDelete={async () => { await onDeleteTransaction(t.id); showToast("ğŸ—‘ï¸ ç´€éŒ„å·²åˆªé™¤"); }} confirmMessage="ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºç´€éŒ„å—ï¼Ÿ">
                                <div className="p-4 flex justify-between items-center w-full">
                                    <div><div className="font-bold text-white">{t.description}</div><div className="text-xs text-slate-500">{new Date(t.date?.seconds * 1000).toLocaleDateString()}</div></div>
                                    <div className="font-mono font-bold text-rose-400">-${t.amount}</div>
                                </div>
                            </SwipeableListItem>
                        ))}
                        {costs.length === 0 && <div className="p-10 text-center text-slate-500">å°šç„¡æ”¯å‡ºç´€éŒ„</div>}
                    </div>
                </div>
            );
        };

        const ShippingCostModal = ({ isOpen, onClose, onSave }) => {
            const [name, setName] = useState(''); const [amount, setAmount] = useState('');
            if(!isOpen) return null;
            const handleSave = () => { if(!name || !amount) return; onSave({ name, amount }); setName(''); setAmount(''); onClose(); };
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center animate-in fade-in duration-200 p-4" style={{zIndex: 9999}}>
                    <div className="bg-slate-900 w-full max-w-sm rounded-2xl p-6 border border-slate-700 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-4">ğŸ’¸ è¨˜éŒ„å…¶ä»–æ”¯å‡º</h3>
                        <div className="space-y-4">
                            <div><label className="block text-slate-400 text-xs mb-1">é …ç›®åç¨±</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬æµ·é‹è²»ã€åŒ…æè²»" /></div>
                            <div><label className="block text-slate-400 text-xs mb-1">é‡‘é¡</label><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" placeholder="$" /></div>
                            <button onClick={handleSave} className="w-full bg-orange-600 text-white font-bold py-3 rounded-xl mt-2 hover:bg-orange-500">è¨˜éŒ„æ”¯å‡º</button>
                            <button onClick={onClose} className="w-full py-2 text-slate-400">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ stats, setIsAddModalOpen, setIsShippingModalOpen, setActiveTab }) => {
            const [avatar, setAvatar] = useState(localStorage.getItem('user_avatar') || 'https://cdn-icons-png.flaticon.com/512/3081/3081559.png');
            const fileInputRef = useRef(null);
            const handleAvatarClick = () => fileInputRef.current.click();
            const handleFileChange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => { const base64 = reader.result; setAvatar(base64); localStorage.setItem('user_avatar', base64); }; reader.readAsDataURL(file); } };

            return (
                <div className="space-y-6 pb-20">
                    <div className="flex justify-between items-center">
                        <div><h1 className="text-2xl font-bold text-white flex items-center gap-2">æ­ªå…”å…”ä»£è³¼ <UsagiIcon /></h1><p className="text-slate-400 text-sm flex items-center gap-1"><Lock size={10} /> OMS v16.2 ç©©å®šä¿®å¾©ç‰ˆ</p></div>
                        <div className="w-12 h-12 rounded-full overflow-hidden border-2 border-slate-700 shadow-lg shadow-pink-500/20 cursor-pointer hover:scale-105 transition-transform relative group" onClick={handleAvatarClick}>
                            <img src={avatar} alt="Avatar" className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><Camera size={16} className="text-white"/></div>
                        </div>
                        <input type="file" ref={fileInputRef} style={{display: 'none'}} accept="image/*" onChange={handleFileChange} />
                    </div>
                    
                    {/* Add Version Badge at bottom of Dashboard */}
                    <div className="text-center">
                        <div className="inline-block px-3 py-1 bg-slate-800 rounded-full text-xs text-slate-500 border border-slate-700">
                            App Version: {APP_VERSION}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <StatCard title="ç›®å‰ç¸½è³‡ç”¢" value={stats.balance} type="balance" icon={Wallet} />
                        <div className="grid grid-cols-2 gap-4 md:col-span-2"><StatCard title="ç¸½æ”¶å…¥" value={stats.income} type="income" icon={ArrowDownLeft} /><StatCard title="ç¸½æ”¯å‡º" value={stats.expense} type="expense" icon={ArrowUpRight} /></div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={() => setIsAddModalOpen(true)} className="bg-gradient-to-r from-indigo-600 to-indigo-500 text-white py-4 rounded-xl shadow-lg flex flex-col items-center justify-center gap-1 font-bold text-sm"><FolderPlus size={24} /> é–‹åœ˜ç®¡ç†</button>
                        <button onClick={() => { setIsShippingModalOpen(true); }} className="bg-gradient-to-r from-orange-600 to-orange-500 text-white py-4 rounded-xl shadow-lg flex flex-col items-center justify-center gap-1 font-bold text-sm"><Banknote size={24} /> è¨˜éŒ„å…¶ä»–æ”¯å‡º</button>
                    </div>
                    <button onClick={() => setActiveTab('shipping_list')} className="w-full bg-slate-800 text-orange-400 font-bold py-3 rounded-xl border border-orange-500/30 hover:bg-slate-700 flex items-center justify-center gap-2 text-sm shadow-sm">ğŸ“‹ æŸ¥çœ‹å…¶ä»–æ”¯å‡ºæ˜ç´°</button>
                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 text-center text-slate-400 text-sm">è«‹å¾ä¸‹æ–¹é¸å–®åˆ‡æ›æª¢è¦–</div>
                </div>
            );
        };

        const CustomersView = memo(({ customers, newCustomer, setNewCustomer, handleAddCustomer, handleDeleteCustomer, showToast }) => {
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            return (
            <div className="h-full flex flex-col">
                <h2 className="text-2xl font-bold text-white mb-6">é¡§å®¢åå–®</h2>
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6 shadow-lg flex-shrink-0">
                    <h3 className="text-white font-medium mb-3 flex items-center gap-2"><UserPlus size={18} className="text-indigo-400"/> æ–°å¢é¡§å®¢</h3>
                    <div className="grid gap-3">
                        <div className="grid grid-cols-2 gap-3">
                            <input type="text" placeholder="æš±ç¨± (å¿…å¡«)" value={newCustomer.name} onChange={(e) => setNewCustomer({...newCustomer, name: e.target.value})} className="bg-slate-900 border border-slate-700 rounded-lg p-2 text-white focus:outline-none focus:border-indigo-500" />
                            <input type="text" placeholder="ç¤¾ç¾¤ ID" value={newCustomer.socialId} onChange={(e) => setNewCustomer({...newCustomer, socialId: e.target.value})} className="bg-slate-900 border border-slate-700 rounded-lg p-2 text-white focus:outline-none focus:border-indigo-500" />
                        </div>
                        <input type="text" placeholder="å‚™è¨»" value={newCustomer.note} onChange={(e) => setNewCustomer({...newCustomer, note: e.target.value})} className="bg-slate-900 border border-slate-700 rounded-lg p-2 text-white focus:outline-none focus:border-indigo-500" />
                        <button onClick={() => { if(!newCustomer.name.trim()) { alert("è«‹è¼¸å…¥é¡§å®¢æš±ç¨±ï¼"); return; } handleAddCustomer(); }} disabled={!newCustomer.name.trim()} className={`text-white py-2 rounded-lg font-medium transition-colors ${newCustomer.name.trim() ? 'bg-indigo-600 hover:bg-indigo-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>å„²å­˜é¡§å®¢è³‡æ–™</button>
                    </div>
                </div>
                <div className="flex-1 overflow-auto space-y-2 custom-scrollbar">
                    {customers.map(c => (
                        <SwipeableListItem key={c.id} onDelete={() => setDeleteConfirmId(c.id)} confirmMessage="ç¢ºå®šè¦åˆªé™¤é€™ä½é¡§å®¢å—ï¼Ÿ">
                            <div className="p-4 flex justify-between items-center w-full">
                                <div><div className="font-bold text-white text-lg">{c.name}</div><div className="text-indigo-400 text-sm mb-1">{c.socialId}</div><div className="text-slate-500 text-sm bg-slate-900/50 p-2 rounded max-w-[200px] truncate">{c.note || "ç„¡å‚™è¨»"}</div></div>
                            </div>
                        </SwipeableListItem>
                    ))}
                </div>
                <ConfirmModal isOpen={!!deleteConfirmId} title="ç¢ºèªåˆªé™¤é¡§å®¢ï¼Ÿ" message="ç¢ºå®šè¦åˆªé™¤é€™ä½é¡§å®¢å—ï¼Ÿé€™ä¸æœƒåˆªé™¤ä»–çš„æ­·å²è¨‚å–®ï¼Œä½†æœƒå¾åå–®ä¸­ç§»é™¤ã€‚" confirmText="åˆªé™¤" isDestructive={true} onConfirm={() => { handleDeleteCustomer(deleteConfirmId); showToast("ğŸ—‘ï¸ é¡§å®¢å·²åˆªé™¤", "error"); setDeleteConfirmId(null); }} onCancel={() => setDeleteConfirmId(null)} />
            </div>
            );
        });

        const GroupOrderModal = ({ isOpen, onClose, customers, categories, onSave, onAddCategory, onDeleteCategory }) => {
            const [mode, setMode] = useState('category'); const [newCategoryName, setNewCategoryName] = useState(''); const [selectedCategory, setSelectedCategory] = useState(''); const [productName, setProductName] = useState(''); const [amount, setAmount] = useState(''); const [selectedCustIds, setSelectedCustIds] = useState(new Set()); const [isProcessing, setIsProcessing] = useState(false); const [custSearch, setCustSearch] = useState(''); const [deleteCatId, setDeleteCatId] = useState(null);
            if (!isOpen) return null;
            const filteredCustomers = customers.filter(c => c.name.toLowerCase().includes(custSearch.toLowerCase()) || c.socialId.toLowerCase().includes(custSearch.toLowerCase()));
            const toggleCustomer = (id) => { const newSet = new Set(selectedCustIds); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedCustIds(newSet); };
            const handleSelectAll = () => { const allVisibleSelected = filteredCustomers.every(c => selectedCustIds.has(c.id)); const newSet = new Set(selectedCustIds); if (allVisibleSelected) filteredCustomers.forEach(c => newSet.delete(c.id)); else filteredCustomers.forEach(c => newSet.add(c.id)); setSelectedCustIds(newSet); };
            const handleCreateCategory = async () => { if (!newCategoryName.trim()) return; await onAddCategory(newCategoryName); setSelectedCategory(newCategoryName); setNewCategoryName(''); setMode('product'); };
            const handleSubmit = async () => { if (!selectedCategory || !productName || !amount || selectedCustIds.size === 0) { if (!selectedCategory) alert("è«‹å…ˆé¸æ“‡å•†å“ä¸»é¡Œï¼"); return; } setIsProcessing(true); const fullName = `[${selectedCategory}] ${productName}`; await onSave({ productName: fullName, amount, quantity: 1, customerIds: Array.from(selectedCustIds) }); setIsProcessing(false); setProductName(''); setAmount(''); setSelectedCustIds(new Set()); setCustSearch(''); onClose(); };
            const handleDeleteCat = async () => { if(!deleteCatId) return; await onDeleteCategory(deleteCatId, true); setDeleteCatId(null); };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-end md:items-center justify-center animate-in fade-in duration-200"><div className="bg-slate-900 w-full md:w-[480px] rounded-t-2xl md:rounded-2xl p-6 border-t md:border border-slate-700 shadow-2xl h-[90vh] md:h-auto flex flex-col"><div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold text-white flex items-center gap-2"><FolderPlus className="text-emerald-400"/> é–‹åœ˜ç®¡ç†</h3><button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24}/></button></div>
                <div className="grid grid-cols-2 gap-3 mb-6"><button onClick={() => setMode('category')} className={`py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 transition-all ${mode === 'category' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}><FolderPlus size={24}/> å»ºç«‹æ–°ä¸»é¡Œ</button><button onClick={() => setMode('product')} className={`py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 transition-all ${mode === 'product' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}><ShoppingBag size={24}/> æ–°å¢å•†å“</button></div>
                {mode === 'category' && ( <div className="space-y-4 animate-in fade-in slide-in-from-left-5"><div className="bg-emerald-500/10 border border-emerald-500/30 p-4 rounded-xl"><label className="block text-emerald-400 font-bold mb-2">æ­¥é©Ÿ 1ï¼šè¼¸å…¥ä¸»é¡Œåç¨±</label><input type="text" value={newCategoryName} onChange={(e) => setNewCategoryName(e.target.value)} className="w-full bg-slate-900 border border-emerald-500/50 text-white p-4 rounded-xl text-lg" placeholder="ä¾‹å¦‚ï¼šå’’è¡“è¿´æˆ°..." autoFocus/></div><button onClick={handleCreateCategory} disabled={!newCategoryName.trim()} className={`w-full py-4 rounded-xl font-bold text-lg ${newCategoryName.trim() ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-500'}`}>ç¢ºèªå»ºç«‹ä¸»é¡Œ</button><div className="mt-4"><label className="block text-slate-400 text-xs mb-2">ç¾æœ‰ä¸»é¡Œåˆ—è¡¨ (å¯åˆªé™¤)</label><div className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">{categories.map(cat => (<div key={cat.id} className="flex justify-between items-center bg-slate-800 p-2 rounded text-sm text-slate-300 border border-slate-700">{cat.name}<button onClick={() => setDeleteCatId(cat.id)} className="text-rose-500 p-2 hover:bg-rose-900/30 rounded"><Trash2 size={16}/></button></div>))}</div></div></div> )}
                {mode === 'product' && ( <div className="flex-1 flex flex-col space-y-4 animate-in fade-in slide-in-from-right-5"><div><label className="block text-slate-400 text-xs mb-1">é¸æ“‡ä¸»é¡Œ (å¿…é¸)</label><div className="relative"><select value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-lg appearance-none"><option value="">-- è«‹ä¸‹æ‹‰é¸æ“‡ä¸»é¡Œ --</option>{categories.map(cat => (<option key={cat.id} value={cat.name}>{cat.name}</option>))}</select><div className="absolute right-3 top-4 pointer-events-none text-slate-500">â–¼</div></div></div><div className="grid grid-cols-3 gap-3"><div className="col-span-2"><label className="block text-slate-400 text-xs mb-1">å•†å“åç¨±</label><input type="text" value={productName} onChange={(e) => setProductName(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-2 rounded-lg" placeholder="ä¾‹å¦‚ï¼šæµ·å ±" /></div><div><label className="block text-slate-400 text-xs mb-1">å–®åƒ¹</label><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-2 rounded-lg" placeholder="$" /></div></div><div className="flex-1 flex flex-col min-h-0"><div className="flex justify-between items-center mb-2"><label className="text-slate-400 text-sm">é¸æ“‡è³¼è²·é¡§å®¢ ({selectedCustIds.size})</label><button onClick={handleSelectAll} className="text-xs text-indigo-400 font-medium">å…¨é¸ / å–æ¶ˆ (ç•¶å‰æœå°‹)</button></div><input type="text" value={custSearch} onChange={(e) => setCustSearch(e.target.value)} placeholder="æœå°‹é¡§å®¢..." className="w-full bg-slate-800 border border-slate-700 text-white p-2 rounded-lg mb-2 text-sm focus:border-indigo-500 outline-none"/><div className="flex-1 overflow-y-auto bg-slate-800 rounded-xl border border-slate-700 p-2 custom-scrollbar"><div className="grid grid-cols-2 gap-2">{filteredCustomers.map(c => { const isSelected = selectedCustIds.has(c.id); return (<div key={c.id} onClick={() => toggleCustomer(c.id)} className={`p-3 rounded-lg border cursor-pointer transition-all flex items-center gap-2 ${isSelected ? 'bg-indigo-600/20 border-indigo-500 text-white' : 'bg-slate-900/50 border-slate-700 text-slate-400'}`}><div className={`w-4 h-4 rounded-full border flex items-center justify-center ${isSelected ? 'bg-indigo-500 border-indigo-500' : 'border-slate-500'}`}>{isSelected && <CheckCircle2 size={12} className="text-white"/>}</div><span className="truncate text-sm">{c.name}</span></div>); })}</div></div></div><button onClick={handleSubmit} disabled={isProcessing || !selectedCategory || !productName || !amount || selectedCustIds.size === 0} className={`w-full text-white font-bold py-4 rounded-xl mt-4 transition-all ${isProcessing || !selectedCategory || !productName || !amount || selectedCustIds.size === 0 ? 'bg-slate-700 text-slate-500' : 'bg-indigo-600 hover:bg-indigo-500 active:scale-95 shadow-lg'}`}>{isProcessing ? 'å»ºç«‹ä¸­...' : `ä¸€éµç”Ÿæˆ ${selectedCustIds.size} ç­†è¨‚å–®`}</button></div> )}
                </div><ConfirmModal isOpen={!!deleteCatId} title="ç¢ºèªåˆªé™¤ä¸»é¡Œï¼Ÿ" message="ç¢ºå®šè¦åˆªé™¤é€™å€‹ä¸»é¡Œå—ï¼Ÿ(ä¸æœƒå½±éŸ¿å·²å»ºç«‹çš„è¨‚å–®)" confirmText="åˆªé™¤" isDestructive={true} onConfirm={handleDeleteCat} onCancel={() => setDeleteCatId(null)} /></div>
            );
        };

        const AddSingleOrderModal = ({ isOpen, onClose, customers, onSave, defaultProduct, defaultPrice }) => {
            const [customerId, setCustomerId] = useState(''); const [quantity, setQuantity] = useState(1); const [amount, setAmount] = useState(defaultPrice || ''); const [note, setNote] = useState(''); const [custSearch, setCustSearch] = useState('');
            useEffect(() => { if(defaultPrice) setAmount(defaultPrice); setQuantity(1); setCustomerId(''); setNote(''); setCustSearch(''); }, [defaultProduct, defaultPrice, isOpen]);
            if (!isOpen) return null;
            const filteredCustomers = customers.filter(c => c.name.toLowerCase().includes(custSearch.toLowerCase()));
            const handleSave = () => { if(!customerId || !amount) return; onSave({ productName: defaultProduct, customerId, quantity: Number(quantity), amount: Number(amount), note }); onClose(); };
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center animate-in fade-in duration-200"><div className="bg-slate-900 w-full max-w-sm rounded-2xl p-6 border border-slate-700 shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-white">è¿½åŠ è¨‚å–®</h3><button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24}/></button></div><div className="mb-4 p-3 bg-slate-800 rounded-lg"><div className="text-xs text-slate-400">å•†å“åç¨±</div><div className="text-white font-bold text-lg">{defaultProduct}</div></div><div className="space-y-4"><div><label className="block text-slate-400 text-sm mb-1">æœå°‹ä¸¦é¸æ“‡é¡§å®¢ (å¿…å¡«)</label><input type="text" value={custSearch} onChange={(e) => setCustSearch(e.target.value)} placeholder="æœå°‹..." className="w-full bg-slate-800 border border-slate-700 text-white p-2 rounded-t-xl text-sm outline-none border-b-0"/><select value={customerId} onChange={(e) => setCustomerId(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-b-xl rounded-t-none"><option value="" disabled>-- è«‹é¸æ“‡ --</option>{filteredCustomers.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}</select></div><div className="grid grid-cols-2 gap-3"><div><label className="block text-slate-400 text-sm mb-1">æ•¸é‡</label><input type="number" value={quantity} onChange={(e) => setQuantity(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" /></div><div><label className="block text-slate-400 text-sm mb-1">ç¸½é‡‘é¡</label><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" /></div></div><div><label className="block text-slate-400 text-sm mb-1">å‚™è¨»</label><input type="text" value={note} onChange={(e) => setNote(e.target.value)} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" /></div><button onClick={handleSave} disabled={!customerId} className={`w-full text-white font-bold py-4 rounded-xl mt-4 ${customerId ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-slate-700 text-slate-500'}`}>ç¢ºèªè¿½åŠ </button></div></div></div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [categories, setCategories] = useState([]);
            const [isGroupModalOpen, setIsGroupModalOpen] = useState(false);
            const [isAppendModalOpen, setIsAppendModalOpen] = useState(false);
            const [isShippingModalOpen, setIsShippingModalOpen] = useState(false);
            const [appendProduct, setAppendProduct] = useState('');
            const [appendPrice, setAppendPrice] = useState('');
            const [newCustomer, setNewCustomer] = useState({ name: '', socialId: '', note: '' });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [editingOrder, setEditingOrder] = useState(null);

            const showToast = (message, type = 'success') => {
                setToast({ show: true, message, type });
                setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
            };

            useEffect(() => {
                if (!auth) return;
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) setUser(u); else signInAnonymously(auth).catch(e => console.error(e));
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const qTrans = query(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions'), orderBy('date', 'desc'));
                const unsubTrans = onSnapshot(qTrans, (s) => setTransactions(s.docs.map(d => ({ id: d.id, ...d.data() }))), (e) => console.error(e));
                const qCust = query(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'customers'), orderBy('createdAt', 'desc'));
                const unsubCust = onSnapshot(qCust, (s) => setCustomers(s.docs.map(d => ({ id: d.id, ...d.data() }))), (e) => console.error(e));
                const qCat = query(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'categories'), orderBy('createdAt', 'desc'));
                const unsubCat = onSnapshot(qCat, (s) => setCategories(s.docs.map(d => ({ id: d.id, ...d.data() }))), (e) => console.error(e));
                return () => { unsubTrans(); unsubCust(); unsubCat(); };
            }, [user]);

            const stats = useMemo(() => {
                let income = 0, expense = 0;
                transactions.forEach(t => { 
                    if (t.type === 'income') income += Number(t.amount); 
                    else if (t.type === 'expense') expense += Number(t.amount); 
                });
                return { income, expense, balance: income - expense };
            }, [transactions]);

            const handleGroupOrder = async ({ productName, amount, customerIds, quantity }) => {
                if (!user) return;
                const batch = writeBatch(db);
                customerIds.forEach(custId => {
                    const cust = customers.find(c => c.id === custId);
                    const newRef = doc(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions'));
                    batch.set(newRef, { description: productName, amount: Number(amount), quantity: Number(quantity) || 1, customerId: custId, customerName: cust ? cust.name : 'æœªçŸ¥é¡§å®¢', type: 'income', category: 'å•†å“æ¡è³¼', status: 'pending', date: serverTimestamp() });
                });
                try { await batch.commit(); showToast("âœ… é–‹åœ˜æˆåŠŸï¼"); } catch (e) { console.error("Batch error", e); alert("å»ºç«‹å¤±æ•—"); }
            };
            
            const handleAppendOrder = async ({ productName, customerId, quantity, amount, note }) => {
                if (!user) return;
                const cust = customers.find(c => c.id === customerId);
                await addDoc(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions'), { description: productName, amount: Number(amount), quantity: Number(quantity), customerId: customerId, customerName: cust ? cust.name : 'æœªçŸ¥é¡§å®¢', note: note || '', type: 'income', category: 'å•†å“æ¡è³¼', status: 'pending', date: serverTimestamp() });
                showToast("âœ… è¿½åŠ æˆåŠŸï¼");
            };

            const handleShippingCost = async ({ name, amount }) => {
                if(!user) return;
                await addDoc(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions'), {
                    type: 'expense',
                    category: 'å…¶ä»–æ”¯å‡º',
                    description: name,
                    amount: Number(amount),
                    status: 'completed',
                    date: serverTimestamp()
                });
                showToast("âœ… æ”¯å‡ºå·²è¨˜éŒ„ï¼");
            };
            
            const handleEditOrder = async (id, data) => {
                if (!user) return;
                try {
                    await updateDoc(doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions', id), data);
                    showToast("âœ… è¨‚å–®å·²ä¿®æ”¹ï¼");
                } catch (e) {
                    console.error(e);
                    showToast("ä¿®æ”¹å¤±æ•—", "error");
                }
            };

            const openAppendModal = (productName, defaultPrice) => { setAppendProduct(productName); setAppendPrice(defaultPrice); setIsAppendModalOpen(true); };
            const handleAddCustomer = async () => { if (!user || !newCustomer.name) return; await addDoc(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'customers'), { ...newCustomer, createdAt: serverTimestamp() }); setNewCustomer({ name: '', socialId: '', note: '' }); showToast("âœ… é¡§å®¢å·²æ–°å¢"); };
            const handleAddCategory = async (name) => { if (!user || !name) return; await addDoc(collection(db, 'runy_buy_shared', SHARED_GROUP_ID, 'categories'), { name, createdAt: serverTimestamp() }); };
            
            const handleDeleteCategory = async (catId, isCategory = false) => {
                if(isCategory) {
                    await deleteDoc(doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'categories', catId));
                    showToast("ğŸ—‘ï¸ ä¸»é¡Œå·²åˆªé™¤");
                } else {
                    await deleteDoc(doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions', catId));
                }
            };

            const handleDeleteCustomer = async (id) => await deleteDoc(doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'customers', id));
            const handleDeleteTransaction = async (id) => await deleteDoc(doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions', id));
            const updateTransactionStatus = async (id, newStatus) => await updateDoc(doc(db, 'runy_buy_shared', SHARED_GROUP_ID, 'transactions', id), { status: newStatus });
            const NavButton = ({ icon: Icon, label, tab }) => ( <button onClick={() => setActiveTab(tab)} className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-colors ${activeTab === tab ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'}`}><Icon size={24} /><span className="text-[10px]">{label}</span></button> );

            if (!firebaseConfig.apiKey) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white p-6 text-center">Config éŒ¯èª¤</div>;
            if (!user) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white"><div className="flex flex-col items-center gap-4"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500"></div><p className="text-slate-400 text-sm">æ­£åœ¨è¼‰å…¥å¸³æœ¬è³‡æ–™...</p></div></div>;

            return (
                <div className="w-full max-w-md mx-auto h-full bg-slate-900 shadow-2xl relative flex flex-col">
                    <Toast message={toast.message} type={toast.type} isVisible={toast.show} onClose={() => setToast(prev => ({ ...prev, show: false }))} />
                    
                    <div className="flex-1 overflow-y-auto p-5 pb-24 custom-scrollbar">
                        {activeTab === 'dashboard' && <DashboardView stats={stats} setIsAddModalOpen={setIsGroupModalOpen} setIsShippingModalOpen={setIsShippingModalOpen} setActiveTab={setActiveTab} />}
                        {activeTab === 'shipping_list' && <ShippingCostView transactions={transactions} onDeleteTransaction={handleDeleteTransaction} showToast={showToast} />}
                        {activeTab === 'orders' && <ActiveOrdersView transactions={transactions} categories={categories} updateTransactionStatus={updateTransactionStatus} onAppendOrder={openAppendModal} onDeleteTransaction={handleDeleteTransaction} onEditOrder={setEditingOrder} showToast={showToast} />}
                        {activeTab === 'waiting' && <WaitingGoodsView transactions={transactions} categories={categories} updateTransactionStatus={updateTransactionStatus} onDeleteTransaction={handleDeleteTransaction} showToast={showToast} />}
                        {activeTab === 'history' && <HistoryView transactions={transactions} handleDeleteTransaction={handleDeleteTransaction} updateTransactionStatus={updateTransactionStatus} showToast={showToast} />}
                        {activeTab === 'customers' && <CustomersView customers={customers} newCustomer={newCustomer} setNewCustomer={setNewCustomer} handleAddCustomer={handleAddCustomer} handleDeleteCustomer={handleDeleteCustomer} showToast={showToast} />}
                    </div>

                    <div className="absolute bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-md border-t border-slate-800 p-2 flex justify-around items-center z-40 pb-6 md:pb-2">
                        <NavButton icon={Wallet} label="é¦–é " tab="dashboard" />
                        <NavButton icon={ClipboardList} label="æ¥å–®" tab="orders" />
                        <button onClick={() => setIsGroupModalOpen(true)} className="bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full -mt-8 shadow-lg shadow-indigo-600/40 border-4 border-slate-900 transition-transform hover:scale-105 active:scale-95"><FolderPlus size={32} /></button>
                        <NavButton icon={Box} label="ç­‰å¾…" tab="waiting" />
                        <NavButton icon={History} label="æ­·å²" tab="history" />
                        <NavButton icon={Users} label="é¡§å®¢" tab="customers" />
                    </div>

                    <GroupOrderModal isOpen={isGroupModalOpen} onClose={() => setIsGroupModalOpen(false)} customers={customers} categories={categories} onSave={handleGroupOrder} onAddCategory={handleAddCategory} onDeleteCategory={handleDeleteCategory} />
                    <AddSingleOrderModal isOpen={isAppendModalOpen} onClose={() => setIsAppendModalOpen(false)} customers={customers} onSave={handleAppendOrder} defaultProduct={appendProduct} defaultPrice={appendPrice} />
                    <ShippingCostModal isOpen={isShippingModalOpen} onClose={() => setIsShippingModalOpen(false)} onSave={handleShippingCost} />
                    <EditOrderModal isOpen={!!editingOrder} onClose={() => setEditingOrder(null)} order={editingOrder} onSave={handleEditOrder} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>