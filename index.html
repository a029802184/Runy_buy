<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>歪兔兔代購</title>
    
    <!-- 加入主畫面設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081559.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* iOS Safe Area Support */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            background-color: #0f172a;
            overscroll-behavior-y: none; /* 防止下拉重整 */
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Users, PlusCircle, Wallet, ArrowUpRight, ArrowDownLeft, 
            Package, Truck, CheckCircle2, UserPlus, Trash2, X, 
            Cloud, Share, HelpCircle
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, 
            orderBy, serverTimestamp, deleteDoc, doc, updateDoc 
        } from 'firebase/firestore';

        // ==========================================
        // --- 設定區域 (請替換成你自己的資料) ---
        // ==========================================
        
        // 請填入你的 Firebase Config (從 Firebase Console 複製)
        const firebaseConfig = {
  apiKey: "AIzaSyAJTIQ0FmzsOSlBRiAzBt7K9upReEQMSn0",
  authDomain: "runy-buy.firebaseapp.com",
  projectId: "runy-buy",
  storageBucket: "runy-buy.firebasestorage.app",
  messagingSenderId: "846500832046",
  appId: "1:846500832046:web:70bd619a66875f9bea90bf",
  measurementId: "G-KYVY0DX7N1"
};

        // ==========================================
        // --- 以下程式碼不需要修改 ---
        // ==========================================

        // Initialize Firebase
        let app, auth, db;
        try {
            if (!firebaseConfig.apiKey) throw new Error("尚未設定 Firebase Config");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const appId = 'daigou-pro-standalone';

        // --- Icons ---
        // 簡單的兔子圖示 SVG
        const UsagiIcon = () => (
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-yellow-300">
                <path d="M12 2C12 2 8 2 7 6C6 10 7 12 7 12C7 12 4 13 4 16C4 19 6 22 12 22C18 22 20 19 20 16C20 13 17 12 17 12C17 12 18 10 17 6C16 2 12 2 12 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M9 15C9 15 10 16 12 16C14 16 15 15 15 15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M9 12H9.01" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M15 12H15.01" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
        );

        // --- Components ---

        const StatCard = ({ title, value, type, icon: Icon }) => (
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                <div className="flex justify-between items-start mb-2">
                    <div className={`p-2 rounded-lg ${
                        type === 'income' ? 'bg-emerald-500/20 text-emerald-400' :
                        type === 'expense' ? 'bg-rose-500/20 text-rose-400' :
                        'bg-blue-500/20 text-blue-400'
                    }`}>
                        <Icon size={20} />
                    </div>
                    <span className="text-slate-400 text-xs font-medium uppercase tracking-wider">{title}</span>
                </div>
                <div className="text-2xl font-bold text-white">
                    {type === 'balance' ? 'NT$ ' : type === 'income' ? '+ ' : '- '}
                    {value.toLocaleString()}
                </div>
            </div>
        );

        const TransactionItem = ({ t, onDelete, onStatusUpdate }) => {
            const isIncome = t.type === 'income';
            const statusColors = {
                pending: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
                purchased: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
                shipped: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                completed: 'bg-slate-700 text-slate-400 border-slate-600',
            };
            const statusLabels = {
                pending: '待處理', purchased: '已採購', shipped: '已發貨', completed: '已結案',
            };

            return (
                <div className="bg-slate-800 rounded-xl p-4 mb-3 border border-slate-700 flex items-center justify-between group">
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                            isIncome ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500'
                        }`}>
                            {isIncome ? <ArrowDownLeft size={20} /> : <ArrowUpRight size={20} />}
                        </div>
                        <div>
                            <div className="font-medium text-white flex items-center gap-2">
                                {t.customerName || '非指定客戶'}
                                <span className="text-slate-500 text-xs font-normal">
                                    {new Date(t.date?.seconds * 1000 || Date.now()).toLocaleDateString()}
                                </span>
                            </div>
                            <div className="text-slate-400 text-sm flex gap-2 items-center mt-1">
                                <span className="bg-slate-700 px-1.5 py-0.5 rounded text-xs">{t.category}</span>
                                {t.description}
                            </div>
                        </div>
                    </div>
                    <div className="text-right flex flex-col items-end gap-1">
                        <div className={`font-bold ${isIncome ? 'text-emerald-400' : 'text-rose-400'}`}>
                            {isIncome ? '+' : '-'}{t.amount?.toLocaleString()}
                        </div>
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => {
                                    const nextStatus = t.status === 'pending' ? 'purchased' :
                                        t.status === 'purchased' ? 'shipped' :
                                        t.status === 'shipped' ? 'completed' : 'pending';
                                    onStatusUpdate(t.id, nextStatus);
                                }}
                                className={`text-xs px-2 py-0.5 rounded-full border cursor-pointer transition-colors ${statusColors[t.status] || statusColors.pending}`}
                            >
                                {statusLabels[t.status] || '未標記'}
                            </button>
                            <button onClick={() => onDelete(t.id)} className="text-slate-600 hover:text-rose-500 transition-colors p-1">
                                <Trash2 size={14} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ stats, transactions, setIsAddModalOpen, setActiveTab, updateTransactionStatus, handleDeleteTransaction }) => (
            <div className="space-y-6 pb-20">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                            歪兔兔代購 <UsagiIcon />
                        </h1>
                        <p className="text-slate-400 text-sm">今天也要努力接單耶！YA HA！</p>
                    </div>
                    {/* Updated Ruby Icon */}
                    <div className="w-12 h-12 bg-gradient-to-br from-rose-500 to-pink-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg shadow-pink-500/30 border-2 border-slate-800 text-xs tracking-wider">
                        Ruby
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <StatCard title="目前總資產" value={stats.balance} type="balance" icon={Wallet} />
                    <div className="grid grid-cols-2 gap-4 md:col-span-2">
                        <StatCard title="總收入" value={stats.income} type="income" icon={ArrowDownLeft} />
                        <StatCard title="總支出" value={stats.expense} type="expense" icon={ArrowUpRight} />
                    </div>
                </div>

                <button 
                    onClick={() => setIsAddModalOpen(true)}
                    className="w-full bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 active:scale-95 text-white py-4 rounded-xl shadow-lg shadow-indigo-500/30 flex items-center justify-center gap-2 font-bold text-lg transition-all"
                >
                    <PlusCircle size={24} />
                    記一筆
                </button>

                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-white font-bold text-lg">最近交易</h2>
                        <button onClick={() => setActiveTab('ledger')} className="text-indigo-400 text-sm">查看全部</button>
                    </div>
                    <div className="space-y-2">
                        {transactions.slice(0, 5).map(t => (
                            <TransactionItem key={t.id} t={t} onStatusUpdate={updateTransactionStatus} onDelete={handleDeleteTransaction} />
                        ))}
                        {transactions.length === 0 && (
                            <div className="text-center py-10 text-slate-500 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">
                                尚無交易紀錄
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );

        const LedgerView = ({ transactions, updateTransactionStatus, handleDeleteTransaction }) => {
            const [filter, setFilter] = useState('全部');
            const filteredTrans = useMemo(() => {
                if (filter === '全部') return transactions;
                if (filter === '收入') return transactions.filter(t => t.type === 'income');
                if (filter === '支出') return transactions.filter(t => t.type === 'expense');
                const statusMap = { '待處理': 'pending', '已採購': 'purchased', '已發貨': 'shipped', '已結案': 'completed' };
                return transactions.filter(t => t.status === statusMap[filter]);
            }, [transactions, filter]);

            return (
                <div className="pb-20 h-full flex flex-col">
                    <h2 className="text-2xl font-bold text-white mb-6">帳本明細</h2>
                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
                        {['全部', '待處理', '已採購', '已發貨', '已結案'].map((f, i) => (
                            <button key={i} onClick={() => setFilter(f)}
                                className={`px-4 py-1.5 rounded-full text-sm whitespace-nowrap transition-colors ${filter === f ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>
                                {f}
                            </button>
                        ))}
                    </div>
                    <div className="flex-1 overflow-y-auto space-y-2 custom-scrollbar pr-2">
                        {filteredTrans.map(t => (
                            <TransactionItem key={t.id} t={t} onStatusUpdate={updateTransactionStatus} onDelete={handleDeleteTransaction}/>
                        ))}
                    </div>
                </div>
            );
        };

        const CustomersView = ({ customers, newCustomer, setNewCustomer, handleAddCustomer, handleDeleteCustomer, prepareTransactionForCustomer }) => (
            <div className="pb-20">
                <h2 className="text-2xl font-bold text-white mb-6">顧客名單</h2>
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-6 shadow-lg">
                    <h3 className="text-white font-medium mb-3 flex items-center gap-2"><UserPlus size={18} className="text-indigo-400"/> 新增顧客</h3>
                    <div className="grid gap-3">
                        <div className="grid grid-cols-2 gap-3">
                            <input type="text" placeholder="暱稱" value={newCustomer.name} onChange={(e) => setNewCustomer({...newCustomer, name: e.target.value})} className="bg-slate-900 border border-slate-700 rounded-lg p-2 text-white focus:outline-none focus:border-indigo-500" />
                            <input type="text" placeholder="社群 ID" value={newCustomer.socialId} onChange={(e) => setNewCustomer({...newCustomer, socialId: e.target.value})} className="bg-slate-900 border border-slate-700 rounded-lg p-2 text-white focus:outline-none focus:border-indigo-500" />
                        </div>
                        <input type="text" placeholder="備註" value={newCustomer.note} onChange={(e) => setNewCustomer({...newCustomer, note: e.target.value})} className="bg-slate-900 border border-slate-700 rounded-lg p-2 text-white focus:outline-none focus:border-indigo-500" />
                        <button onClick={handleAddCustomer} className="bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-500 active:scale-95 transition-transform">儲存顧客資料</button>
                    </div>
                </div>
                <div className="grid gap-3">
                    {customers.map(c => (
                        <div key={c.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center group">
                            <div>
                                <div className="font-bold text-white text-lg">{c.name}</div>
                                <div className="text-indigo-400 text-sm mb-1">{c.socialId}</div>
                                <div className="text-slate-500 text-sm bg-slate-900/50 p-2 rounded max-w-[200px] truncate">{c.note || "無備註"}</div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => handleDeleteCustomer(c.id)} className="p-2 bg-rose-500/10 text-rose-500 rounded-lg"><Trash2 size={20} /></button>
                                <button onClick={() => prepareTransactionForCustomer(c)} className="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg"><PlusCircle size={20} /></button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const AddTransactionModal = ({ isOpen, onClose, newTrans, setNewTrans, templates, applyTemplate, customers, onSave }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-end md:items-center justify-center animate-in fade-in duration-200">
                    <div className="bg-slate-900 w-full md:w-96 rounded-t-2xl md:rounded-2xl p-6 border-t md:border border-slate-700 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-white flex items-center gap-2">新增交易</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24}/></button>
                        </div>
                        <div className="grid grid-cols-4 gap-2 mb-6">
                            {templates.map((tpl, idx) => (
                                <button key={idx} onClick={() => applyTemplate(tpl)} className={`flex flex-col items-center gap-1 p-2 rounded-lg border transition-colors ${newTrans.category === tpl.category ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>
                                    <tpl.icon size={18} /> <span className="text-[10px] md:text-xs">{tpl.label}</span>
                                </button>
                            ))}
                        </div>
                        <div className="space-y-4">
                            <div><label className="block text-slate-400 text-sm mb-1">金額</label><input type="number" value={newTrans.amount} onChange={(e) => setNewTrans({...newTrans, amount: e.target.value})} className="w-full bg-slate-800 border border-slate-700 text-white text-2xl font-bold p-3 rounded-xl" placeholder="0" /></div>
                            <div>
                                <label className="block text-slate-400 text-sm mb-1">顧客</label>
                                <select value={newTrans.customerId} onChange={(e) => { const cust = customers.find(c => c.id === e.target.value); setNewTrans({...newTrans, customerId: e.target.value, customerName: cust ? cust.name : ''}); }} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl">
                                    <option value="">-- 無 / 一般交易 --</option>
                                    {customers.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}
                                </select>
                            </div>
                            <div><label className="block text-slate-400 text-sm mb-1">備註</label><input type="text" value={newTrans.description} onChange={(e) => setNewTrans({...newTrans, description: e.target.value})} className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl" placeholder="說明" /></div>
                            <button onClick={onSave} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl mt-4 hover:bg-indigo-500">確認儲存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [newTrans, setNewTrans] = useState({ type: 'income', amount: '', description: '', customerId: '', customerName: '', category: '代購訂金', status: 'pending' });
            const [newCustomer, setNewCustomer] = useState({ name: '', socialId: '', note: '' });

            useEffect(() => {
                if (!auth) return;
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) setUser(u);
                    else signInAnonymously(auth).catch(e => console.error(e));
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const qTrans = query(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), orderBy('date', 'desc'));
                const unsubTrans = onSnapshot(qTrans, (s) => setTransactions(s.docs.map(d => ({ id: d.id, ...d.data() }))), (e) => console.error(e));
                const qCust = query(collection(db, 'artifacts', appId, 'users', user.uid, 'customers'), orderBy('createdAt', 'desc'));
                const unsubCust = onSnapshot(qCust, (s) => setCustomers(s.docs.map(d => ({ id: d.id, ...d.data() }))), (e) => console.error(e));
                return () => { unsubTrans(); unsubCust(); };
            }, [user]);

            const stats = useMemo(() => {
                let income = 0, expense = 0;
                transactions.forEach(t => { if (t.type === 'income') income += Number(t.amount); else expense += Number(t.amount); });
                return { income, expense, balance: income - expense };
            }, [transactions]);

            const handleAddTransaction = async () => {
                if (!user || !newTrans.amount) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), { ...newTrans, amount: Number(newTrans.amount), date: serverTimestamp() });
                setIsAddModalOpen(false);
                setNewTrans({ type: 'income', amount: '', description: '', customerId: '', customerName: '', category: '代購訂金', status: 'pending' });
            };

            const handleAddCustomer = async () => {
                if (!user || !newCustomer.name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'customers'), { ...newCustomer, createdAt: serverTimestamp() });
                setNewCustomer({ name: '', socialId: '', note: '' });
            };

            const handleDeleteCustomer = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'customers', id));
            const handleDeleteTransaction = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id));
            const updateTransactionStatus = async (id, newStatus) => await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id), { status: newStatus });
            const prepareTransactionForCustomer = (c) => { setNewTrans(prev => ({...prev, customerId: c.id, customerName: c.name})); setIsAddModalOpen(true); };

            const templates = [
                { label: '收到訂金', type: 'income', category: '代購訂金', status: 'pending', icon: Wallet },
                { label: '購買商品', type: 'expense', category: '商品採購', status: 'purchased', icon: Package },
                { label: '支付運費', type: 'expense', category: '國際運費', status: 'shipped', icon: Truck },
                { label: '補款結算', type: 'income', category: '尾款補款', status: 'completed', icon: CheckCircle2 },
            ];
            
            const applyTemplate = (tpl) => setNewTrans(prev => ({ ...prev, type: tpl.type, category: tpl.category, description: tpl.description || '', status: tpl.status }));

            if (!firebaseConfig.apiKey) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white p-6 text-center">請先編輯此 index.html 檔案<br/>填入您的 Firebase Config</div>;
            if (!user) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white">載入中...</div>;

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-indigo-500/30">
                    <div className="max-w-md mx-auto min-h-screen relative bg-slate-900 shadow-2xl overflow-hidden">
                        <div className="h-full overflow-y-auto p-5 custom-scrollbar pb-24">
                            {activeTab === 'dashboard' && <DashboardView stats={stats} transactions={transactions} setIsAddModalOpen={setIsAddModalOpen} setActiveTab={setActiveTab} updateTransactionStatus={updateTransactionStatus} handleDeleteTransaction={handleDeleteTransaction} />}
                            {activeTab === 'ledger' && <LedgerView transactions={transactions} updateTransactionStatus={updateTransactionStatus} handleDeleteTransaction={handleDeleteTransaction} />}
                            {activeTab === 'customers' && <CustomersView customers={customers} newCustomer={newCustomer} setNewCustomer={setNewCustomer} handleAddCustomer={handleAddCustomer} handleDeleteCustomer={handleDeleteCustomer} prepareTransactionForCustomer={prepareTransactionForCustomer} />}
                        </div>
                        <div className="absolute bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-md border-t border-slate-800 p-2 flex justify-around items-center z-40 pb-6 md:pb-2">
                            <button onClick={() => setActiveTab('dashboard')} className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-colors ${activeTab === 'dashboard' ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'}`}><Wallet size={24} /><span className="text-[10px]">概覽</span></button>
                            <button onClick={() => setIsAddModalOpen(true)} className="bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full -mt-8 shadow-lg shadow-indigo-600/40 border-4 border-slate-900 transition-transform hover:scale-105 active:scale-95"><PlusCircle size={32} /></button>
                            <button onClick={() => setActiveTab('customers')} className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-colors ${activeTab === 'customers' ? 'text-indigo-400' : 'text-slate-500 hover:text-slate-300'}`}><Users size={24} /><span className="text-[10px]">顧客</span></button>
                        </div>
                    </div>
                    <AddTransactionModal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} newTrans={newTrans} setNewTrans={setNewTrans} templates={templates} applyTemplate={applyTemplate} customers={customers} onSave={handleAddTransaction} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
